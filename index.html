<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Anatomical Model with Labels</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/ar.js/2.2.1/aframe/build/aframe-ar.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    .a-loader-title { display: none; }
  </style>
</head>
<body>
  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
  >
    <a-assets>
      <!-- 3D Model -->
      <a-asset-item id="heartModel" src="heart.glb"></a-asset-item>

      <!-- Audio Files -->
      <audio id="audio-heart" src="audio/heart.mp3"></audio>
      <audio id="audio-liver" src="audio/liver.mp3"></audio>
      <audio id="audio-stomach" src="audio/stomach.mp3"></audio>
      <audio id="audio-pancreas" src="audio/pancreas.mp3"></audio>
      <audio id="audio-gallbladder" src="audio/gallbladder.mp3"></audio>
      <audio id="audio-smallintestine" src="audio/smallintestine.mp3"></audio>
      <audio id="audio-largeintestine" src="audio/largeintestine.mp3"></audio>
    </a-assets>

    <!-- Marker -->
    <a-marker type="pattern" url="marker.patt">
      <a-entity id="modelContainer" scale="0.5 0.5 0.5">
        <a-gltf-model src="#heartModel"></a-gltf-model>

        <!-- Labels and Audio Triggers -->
        <a-entity id="labels" add-labels></a-entity>
      </a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    AFRAME.registerComponent('add-labels', {
      init: function () {
        const labels = [
          { name: 'Heart', position: { x: 0, y: 1, z: 0 }, audioId: 'audio-heart' },
          { name: 'Liver', position: { x: 1, y: 0.5, z: 0 }, audioId: 'audio-liver' },
          { name: 'Stomach', position: { x: -1, y: 0.5, z: 0 }, audioId: 'audio-stomach' },
          { name: 'Pancreas', position: { x: 0.5, y: 0.3, z: 1 }, audioId: 'audio-pancreas' },
          { name: 'Gallbladder', position: { x: -0.5, y: 0.3, z: 1 }, audioId: 'audio-gallbladder' },
          { name: 'Small Intestine', position: { x: 0.5, y: -0.5, z: 0 }, audioId: 'audio-smallintestine' },
          { name: 'Large Intestine', position: { x: -0.5, y: -0.5, z: 0 }, audioId: 'audio-largeintestine' }
        ];

        const container = this.el;
        labels.forEach(part => {
          const label = document.createElement('a-entity');
          label.setAttribute('position', part.position);
          label.setAttribute('scale', '0.3 0.3 0.3');

          const labelPlane = document.createElement('a-plane');
          labelPlane.setAttribute('width', '1');
          labelPlane.setAttribute('height', '0.4');
          labelPlane.setAttribute('color', '#ffcc00');
          labelPlane.setAttribute('look-at', '[camera]');
          labelPlane.setAttribute('text', {
            value: part.name,
            align: 'center',
            color: '#000000',
            width: 2
          });
          labelPlane.setAttribute('play-audio-on-click', `audioId: ${part.audioId}`);
          label.appendChild(labelPlane);
          container.appendChild(label);
        });
      }
    });

    AFRAME.registerComponent('play-audio-on-click', {
      schema: { audioId: { type: 'string' } },
      init: function () {
        this.el.addEventListener('click', () => {
          const audio = document.querySelector(`#${this.data.audioId}`);
          if (audio) {
            audio.pause();
            audio.currentTime = 0;
            audio.play();
          }
        });
      }
    });

    AFRAME.registerComponent('drag-rotate', {
      schema: {
        rotationFactor: { type: 'number', default: 5 },
        zoomFactor: { type: 'number', default: 0.005 },
        panFactor: { type: 'number', default: 0.005 },
        scale: { type: 'number', default: 1 }
      },
      init: function () {
        this.previousPosition = null;
        this.previousDistance = null;
        this.isDragging = false;
        this.el.sceneEl.addEventListener('touchstart', this.handleTouchStart.bind(this));
        this.el.sceneEl.addEventListener('touchmove', this.handleTouchMove.bind(this));
        this.el.sceneEl.addEventListener('touchend', this.handleTouchEnd.bind(this));
      },
      handleTouchStart: function (e) {
        if (e.touches.length === 1) {
          this.isDragging = true;
          this.previousPosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        } else if (e.touches.length === 2) {
          this.previousDistance = this.getTouchDistance(e.touches);
        }
      },
      handleTouchMove: function (e) {
        if (e.touches.length === 1 && this.isDragging) {
          const dx = e.touches[0].clientX - this.previousPosition.x;
          const dy = e.touches[0].clientY - this.previousPosition.y;
          const rotation = this.el.getAttribute('rotation');
          this.el.setAttribute('rotation', {
            x: rotation.x + dy / this.data.rotationFactor,
            y: rotation.y + dx / this.data.rotationFactor,
            z: rotation.z
          });
          this.previousPosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        } else if (e.touches.length === 2) {
          const currentDistance = this.getTouchDistance(e.touches);
          const delta = currentDistance - this.previousDistance;
          this.data.scale += delta * this.data.zoomFactor;
          this.data.scale = Math.max(0.1, Math.min(5, this.data.scale));
          this.el.setAttribute('scale', `${this.data.scale} ${this.data.scale} ${this.data.scale}`);
          this.previousDistance = currentDistance;
        }
      },
      handleTouchEnd: function () {
        this.isDragging = false;
        this.previousDistance = null;
      },
      getTouchDistance: function (touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }
    });

    document.getElementById('modelContainer').setAttribute('drag-rotate', '');
  </script>
</body>
</html>
