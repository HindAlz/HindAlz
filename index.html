<!DOCTYPE html>
<html>
  <head>
    <title>Heart WebAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { 
        margin: 0; 
        overflow: hidden; 
        -webkit-touch-callout: none;
        touch-action: none;
      }
      #startOverlay {
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        background: rgba(0, 0, 0, 0.9); 
        z-index: 9999;
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        align-items: center;
        color: white; 
        text-align: center;
      }
      #startButton {
        margin-top: 20px; 
        padding: 15px 30px; 
        font-size: 18px;
        background: #4CAF50; 
        color: white; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      /* AR.js optimizations */
      .a-enter-vr, .a-orientation-modal {
        display: none !important;
      }
      canvas {
        display: block;
        width: 100% !important;
        height: auto !important;
      }
      .arjs-video {
        width: 100% !important;
        height: auto !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        transform: none !important;
      }
      /* Label styling */
      .ar-label {
        font-family: Arial, sans-serif;
        font-weight: bold;
        pointer-events: all;
      }
      .ar-label-bg {
        background: rgba(255,255,255,0.8);
        padding: 0.2rem 0.5rem;
        border-radius: 0.5rem;
      }
    </style>
  </head>
  <body>
    <!-- Start Overlay -->
    <div id="startOverlay">
      <h2>Heart AR Experience</h2>
      <p>Point your camera at the Hiro marker</p>
      <button id="startButton">Start</button>
    </div>

    <!-- Scene -->
    <a-scene
      embedded
      arjs="sourceType: webcam; 
            debugUIEnabled: false; 
            cameraParametersUrl: https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/data/camera_para.dat;
            detectionMode: mono_and_matrix;
            matrixCodeType: 3x3;
            maxDetectionRate: 30;
            sourceWidth: 640;
            sourceHeight: 480;"
      renderer="logarithmicDepthBuffer: false; precision: low; antialias: false"
    >
      <a-assets>
        <audio id="beepSound" src="audio/beep.mp3" preload="auto"></audio>
        <audio id="aortaAudio" src="audio/aorta.mp3" preload="auto"></audio>
        <audio id="ventricleAudio" src="audio/ventricle.mp3" preload="auto"></audio>
        <a-asset-item id="heartGLB" src="body.glb"></a-asset-item>
      </a-assets>

      <!-- Marker-based -->
      <a-marker 
        preset="hiro" 
        id="marker" 
        emitevents="true"
        type="pattern"
        url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/data/patt.hiro"
      >
        <a-entity
          id="markerHeart"
          visible="false"
          gltf-model="#heartGLB"
          scale="0.03 0.03 0.03"
          rotation="0 0 0"
          position="0 0 0"
          ar-model-interaction
        ></a-entity>
      </a-marker>

      <!-- Camera -->
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // Start Experience
      document.getElementById('startButton').addEventListener('click', function() {
        document.getElementById('startOverlay').style.display = 'none';
        
        // iOS audio workaround
        const audios = document.querySelectorAll('audio');
        audios.forEach(audio => {
          audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
          }).catch(err => {
            console.warn('Audio play failed:', err);
          });
        });
      });

      // Marker events
      const marker = document.querySelector('#marker');
      marker.addEventListener('markerFound', () => {
        const heart = document.getElementById('markerHeart');
        heart.setAttribute('visible', true);
        
        // Add labels if not already added
        if (!heart.hasAttribute('labels-added')) {
          addLabelsToHeart(heart);
          heart.setAttribute('labels-added', 'true');
        }
      });
      
      marker.addEventListener('markerLost', () => {
        document.getElementById('markerHeart').setAttribute('visible', false);
      });

      // Add labels to heart model
      function addLabelsToHeart(heartEntity) {
        const parts = [
          { 
            name: 'Aorta', 
            position: { x: 0.5, y: 0.8, z: 0.2 },
            audioId: 'aortaAudio',
            color: '#FF0000'
          },
          { 
            name: 'Ventricle', 
            position: { x: -0.3, y: 0.4, z: 0.1 },
            audioId: 'ventricleAudio',
            color: '#00AAFF'
          }
        ];

        parts.forEach((part) => {
          // Create label container
          const label = document.createElement('a-entity');
          label.setAttribute('position', part.position);
          label.setAttribute('class', 'ar-label');
          label.setAttribute('look-at', '[camera]');
          label.setAttribute('billboard', '');
          
          // Create background
          const bg = document.createElement('a-plane');
          bg.setAttribute('class', 'ar-label-bg');
          bg.setAttribute('material', `color: ${part.color}; opacity: 0.8`);
          bg.setAttribute('width', 'auto');
          bg.setAttribute('height', 'auto');
          bg.setAttribute('play-audio-on-click', `audioId: ${part.audioId}`);
          
          // Create text
          const text = document.createElement('a-text');
          text.setAttribute('value', part.name);
          text.setAttribute('align', 'center');
          text.setAttribute('color', '#FFFFFF');
          text.setAttribute('width', '3');
          text.setAttribute('position', '0 0 0.01');
          
          // Assemble components
          bg.appendChild(text);
          label.appendChild(bg);
          heartEntity.appendChild(label);
        });
      }

      // Audio component
      AFRAME.registerComponent('play-audio-on-click', {
        schema: { audioId: { type: 'string' } },
        init: function() {
          this.onClick = () => {
            const audio = document.querySelector(`#${this.data.audioId}`);
            if (audio) {
              audio.currentTime = 0;
              audio.play().catch(e => console.warn('Audio play failed:', e));
            }
          };
          this.el.addEventListener('click', this.onClick);
          this.el.addEventListener('touchstart', this.onClick);
        },
        remove: function() {
          this.el.removeEventListener('click', this.onClick);
          this.el.removeEventListener('touchstart', this.onClick);
        }
      });

      // Rotation and Zoom interaction component
      AFRAME.registerComponent('ar-model-interaction', {
        init: function() {
          this.scale = 1;
          this.rotation = { x: 0, y: 0 };
          this.isDragging = false;
          this.lastPos = { x: 0, y: 0 };
          
          // Event listeners
          this.onStart = this.onStart.bind(this);
          this.onMove = this.onMove.bind(this);
          this.onEnd = this.onEnd.bind(this);
          this.onWheel = this.onWheel.bind(this);
          
          this.el.sceneEl.addEventListener('mousedown', this.onStart);
          this.el.sceneEl.addEventListener('touchstart', this.onStart);
          window.addEventListener('mousemove', this.onMove);
          window.addEventListener('touchmove', this.onMove);
          window.addEventListener('mouseup', this.onEnd);
          window.addEventListener('touchend', this.onEnd);
          this.el.sceneEl.addEventListener('wheel', this.onWheel);
        },
        
        onStart: function(e) {
          this.isDragging = true;
          this.lastPos = this.getInputPosition(e);
        },
        
        onMove: function(e) {
          if (!this.isDragging) return;
          
          const currentPos = this.getInputPosition(e);
          const dx = currentPos.x - this.lastPos.x;
          const dy = currentPos.y - this.lastPos.y;
          
          this.rotation.y += dx * 0.5;
          this.rotation.x += dy * 0.5;
          
          this.el.setAttribute('rotation', {
            x: this.rotation.x,
            y: this.rotation.y,
            z: 0
          });
          
          this.lastPos = currentPos;
          e.preventDefault();
        },
        
        onEnd: function() {
          this.isDragging = false;
        },
        
        onWheel: function(e) {
          e.preventDefault();
          this.scale += -e.deltaY * 0.001;
          this.scale = Math.max(0.01, Math.min(2, this.scale));
          this.el.setAttribute('scale', `${this.scale} ${this.scale} ${this.scale}`);
        },
        
        getInputPosition: function(e) {
          if (e.touches && e.touches.length > 0) {
            return {
              x: e.touches[0].clientX,
              y: e.touches[0].clientY
            };
          }
          return {
            x: e.clientX,
            y: e.clientY
          };
        },
        
        remove: function() {
          this.el.sceneEl.removeEventListener('mousedown', this.onStart);
          this.el.sceneEl.removeEventListener('touchstart', this.onStart);
          window.removeEventListener('mousemove', this.onMove);
          window.removeEventListener('touchmove', this.onMove);
          window.removeEventListener('mouseup', this.onEnd);
          window.removeEventListener('touchend', this.onEnd);
          this.el.sceneEl.removeEventListener('wheel', this.onWheel);
        }
      });
    </script>
  </body>
</html>