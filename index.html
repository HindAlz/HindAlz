<!DOCTYPE html>
<html>
  <head>
    <title>Heart WebAR - Marker Only</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
    </style>
  </head>
  <body>
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; cameraParametersUrl: camera_para.dat">
      <a-assets>
        <audio id="heartAudio" src="audio/aorta.mp3" preload="auto"></audio>
        <audio id="liverAudio" src="audio/aorta.mp3" preload="auto"></audio>
        <a-asset-item id="bodyGLB" src="body.glb"></a-asset-item>
        <a-asset-item id="heartGLB" src="heart.glb"></a-asset-item>
      </a-assets>

      <!-- Lighting -->
      <a-entity light="type: ambient; color: #ffffff; intensity: 1.5"></a-entity>
      <a-entity light="type: directional; color: #ffffff; intensity: 1" position="1 2 1"></a-entity>

      <!-- Marker 1: Body -->
      <a-marker id="customMarker" type="pattern" preset="custom" url="marker.patt" emitevents="true">
        <a-entity id="markerBody" gltf-model="body.glb" scale="0.05 0.05 0.05" rotation="-90 0 0" visible="false" zoom-listener rotation-listener>
          <!-- Labels for Body -->
          <a-text value="Liver" position="0 1 0" scale="2 2 2" color="green" class="clickable" onclick="playAudio('liverAudio')"></a-text>
        </a-entity>
      </a-marker>

      <!-- Marker 2: Heart -->
      <a-marker id="heartMarker" type="pattern" preset="custom" url="heart-marker.patt" emitevents="true">
        <a-entity id="markerHeart" gltf-model="heart.glb" scale="0.5 0.5 0.5" rotation="-90 0 0" visible="false" zoom-listener rotation-listener>
          <!-- Labels for Heart -->
          <a-text value="Aorta" position="0 0.5 0" scale="2 2 2" color="blue" class="clickable" onclick="playAudio('heartAudio')"></a-text>
        </a-entity>
      </a-marker>

      <!-- Camera + Cursor -->
      <a-entity camera cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-scene>

    <script>
      AFRAME.registerComponent('add-labels-on-load', {
        init: function () {
          this.el.addEventListener('model-loaded', () => {
            this.el.setAttribute('add-labels', '');
          });
        }
      });

      AFRAME.registerComponent('add-labels', {
        init: function () {
          const parts = [
            { name: 'Liver', position: { x: 0.3, y: 1.1, z: 0 }, audioId: 'liverAudio' },
          ];

          const parent = this.el.parentEl; // attach labels to modelGroup

          parts.forEach((part) => {
            const label = document.createElement('a-entity');
            label.setAttribute('text', {
              value: part.name,
              align: 'center',
              width: 6,
              color: '#000',
              baseline: 'center',
              wrapCount: 30
            });
            label.setAttribute('position', part.position);
            label.setAttribute('geometry', {
              primitive: 'plane',
              height: 0.7,
              width: 3
            });
            label.setAttribute('material', {
              color: '#fff',
              opacity: 0.9
            });
            label.setAttribute('class', 'clickable');
            label.setAttribute('play-audio-on-click', `audioId: ${part.audioId}`);

            parent.appendChild(label);
          });
        }
      });

      AFRAME.registerComponent('heart-add-labels-on-load', {
        init: function () {
          this.el.addEventListener('model-loaded', () => {
            this.el.setAttribute('heart-add-labels', '');
          });
        }
      });

      AFRAME.registerComponent('heart-add-labels', {
        init: function () {
          const parts = [
            { name: 'Aorta', position: { x: 0.3, y: 1.1, z: 0 }, audioId: 'aortaAudio' },
          ];

          const parent = this.el.parentEl; // attach labels to modelGroup

          parts.forEach((part) => {
            const label = document.createElement('a-entity');
            label.setAttribute('text', {
              value: part.name,
              align: 'center',
              width: 6,
              color: '#000',
              baseline: 'center',
              wrapCount: 30
            });
            label.setAttribute('position', part.position);
            label.setAttribute('geometry', {
              primitive: 'plane',
              height: 0.7,
              width: 3
            });
            label.setAttribute('material', {
              color: '#fff',
              opacity: 0.9
            });
            label.setAttribute('class', 'clickable');
            label.setAttribute('play-audio-on-click', `audioId: ${part.audioId}`);

            parent.appendChild(label);
          });
        }
      });

      AFRAME.registerComponent('play-audio-on-click', {
        schema: { audioId: { type: 'string' } },
        init: function () {
          this.el.addEventListener('click', () => {
            const audio = document.querySelector(`#${this.data.audioId}`);
            if (audio) {
              audio.play().catch(err => console.warn('Audio play error:', err));
            }
          });
        }
      });

      // Rotation with drag
      AFRAME.registerComponent('rotation-listener', {
        init: function () {
          let isDragging = false;
          let previousX = null;
          const el = this.el;

          const onStart = (e) => {
            isDragging = true;
            previousX = e.touches ? e.touches[0].clientX : e.clientX;
          };

          const onMove = (e) => {
            if (!isDragging) return;
            const currentX = e.touches ? e.touches[0].clientX : e.clientX;
            const deltaX = currentX - previousX;
            previousX = currentX;

            const rotation = el.getAttribute('rotation');
            rotation.y += deltaX * 0.5;
            el.setAttribute('rotation', rotation);
          };

          const onEnd = () => { isDragging = false; };

          document.addEventListener('mousedown', onStart);
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onEnd);

          document.addEventListener('touchstart', onStart);
          document.addEventListener('touchmove', onMove);
          document.addEventListener('touchend', onEnd);
        }
      });

      // Zoom using mouse wheel or pinch gesture
      AFRAME.registerComponent('zoom-listener', {
        init: function () {
          const el = this.el;

          // Mouse scroll zoom
          window.addEventListener('wheel', function (e) {
            const scale = el.getAttribute('scale');
            const zoomFactor = 1 + (e.deltaY > 0 ? -0.1 : 0.1);
            const newScale = {
              x: Math.max(0.01, scale.x * zoomFactor),
              y: Math.max(0.01, scale.y * zoomFactor),
              z: Math.max(0.01, scale.z * zoomFactor)
            };
            el.setAttribute('scale', newScale);
          });

          // Pinch zoom (mobile)
          let initialDistance = null;

          document.addEventListener('touchmove', function (e) {
            if (e.touches.length === 2) {
              const dx = e.touches[0].clientX - e.touches[1].clientX;
              const dy = e.touches[0].clientY - e.touches[1].clientY;
              const distance = Math.sqrt(dx * dx + dy * dy);

              if (initialDistance === null) {
                initialDistance = distance;
              } else {
                const scale = el.getAttribute('scale');
                const zoomFactor = distance / initialDistance;
                const newScale = {
                  x: Math.max(0.01, scale.x * zoomFactor),
                  y: Math.max(0.01, scale.y * zoomFactor),
                  z: Math.max(0.01, scale.z * zoomFactor)
                };
                el.setAttribute('scale', newScale);
              }
            }
          });

          document.addEventListener('touchend', function () {
            initialDistance = null;
          });
        }
      });
    </script>
  </body>
</html>
