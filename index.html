<!DOCTYPE html>
<html>
  <head>
    <title>Heart & Body WebAR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #startOverlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
    </style>
  </head>
  <body>
    <div id="startOverlay" onclick="startExperience()">face phone on marker 
      pinch model to zoom in and out 
      rotate model using one finger
      Tap to Start</div>

    <!-- ðŸ”Š Audio tags must be in body directly -->
    <audio id="aortaAudio" src="audio/aorta.mp3" preload="auto"></audio>
    <audio id="liverAudio" src="audio/aorta.mp3" preload="auto"></audio>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; cameraParametersUrl: camera_para.dat">
      <a-assets>
        <a-asset-item id="heartGLB" src="heart.glb"></a-asset-item>
        <a-asset-item id="bodyGLB" src="body.glb"></a-asset-item>
      </a-assets>

      <!-- Lighting -->
      <a-entity light="type: ambient; color: #ffffff; intensity: 10"></a-entity>
      <a-entity light="type: directional; color: #ffffff; intensity: 10" position="1 3 2"></a-entity>

      <!-- Heart Marker -->
      <a-marker id="heartMarker" type="pattern" url="heart-marker.patt" emitevents="true">
        <a-entity 
          id="heartModel" 
          gltf-model="#heartGLB" 
          scale="0.1 0.1 0.1" 
          rotation="0 0 0"
          interactable-model
          load-heart-labels>
        </a-entity>
      </a-marker>

      <!-- Body Marker -->
      <a-marker id="bodyMarker" type="pattern" url="marker.patt" emitevents="true">
        <a-entity 
          id="bodyModel" 
          gltf-model="#bodyGLB" 
          scale="0.1 0.1 0.1"  
          rotation="0 0 0"
          interactable-model
          load-body-labels
          material="color: white;">
        </a-entity>
      </a-marker>

      <!-- Extra lighting -->
      <a-entity light="type: ambient; intensity: 10; color: #ffffff"></a-entity>
      <a-entity light="type: directional; intensity: 10; position=1 2 1; color=#ffffff"></a-entity>
      
      <!-- Camera + Cursor -->
      <a-entity id="mainCamera" camera cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-scene>

    <script>
      // âœ… Unlock audio on gesture
      function startExperience() {
  document.getElementById("startOverlay").style.display = "none";
  const context = new (window.AudioContext || window.webkitAudioContext)();
  const unlock = () => {
    if (context.state === 'suspended') {
      context.resume();
    }

    // ðŸ‘‡ Play and pause once to unlock each audio element
    const audios = document.querySelectorAll('audio');
    audios.forEach(audio => {
      audio.play().then(() => audio.pause()).catch(err => console.warn("Unlock play error:", err));
    });

    document.removeEventListener('touchend', unlock);
    document.removeEventListener('click', unlock);
  };
  document.addEventListener('touchend', unlock, false);
  document.addEventListener('click', unlock, false);
}


      AFRAME.registerComponent('play-audio-on-click', {
        schema: { audioId: { type: 'string' } },
        init: function () {
          this.el.addEventListener('click', () => {
            const audio = document.getElementById(this.data.audioId);
            if (audio) {
              audio.currentTime = 0;
              audio.play().then(() => {
                console.log("Audio played.");
              }).catch(err => {
                console.warn("Audio play error:", err);
              });
            }
          });
        }
      });

      AFRAME.registerComponent('interactable-model', {
  schema: {
    autoRotateSpeed: { type: 'number', default: 0.3 }
  },
  init: function () {
    const el = this.el;
    this.isDragging = false;
    this.previousX = null;

    const onStart = (e) => {
      this.isDragging = true;
      this.previousX = e.touches ? e.touches[0].clientX : e.clientX;
    };
    const onMove = (e) => {
      if (!this.isDragging) return;
      const currentX = e.touches ? e.touches[0].clientX : e.clientX;
      const deltaX = currentX - this.previousX;
      this.previousX = currentX;
      const rotation = el.getAttribute('rotation');
      rotation.y += deltaX * 0.5;
      el.setAttribute('rotation', rotation);
    };
    const onEnd = () => { this.isDragging = false; };

    document.addEventListener('mousedown', onStart);
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onEnd);
    document.addEventListener('touchstart', onStart);
    document.addEventListener('touchmove', onMove);
    document.addEventListener('touchend', onEnd);

    // Mouse wheel zoom
    window.addEventListener('wheel', (e) => {
      const scale = el.getAttribute('scale');
      const zoom = 1 + (e.deltaY > 0 ? -0.1 : 0.1);
      el.setAttribute('scale', {
        x: Math.max(0.01, scale.x * zoom),
        y: Math.max(0.01, scale.y * zoom),
        z: Math.max(0.01, scale.z * zoom)
      });
    });

    // Pinch zoom
    let initialDistance = null;
    document.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (initialDistance === null) {
          initialDistance = distance;
        } else {
          const scale = el.getAttribute('scale');
          const zoom = distance / initialDistance;
          el.setAttribute('scale', {
            x: Math.max(0.01, scale.x * zoom),
            y: Math.max(0.01, scale.y * zoom),
            z: Math.max(0.01, scale.z * zoom)
          });
        }
      }
    });
    document.addEventListener('touchend', () => initialDistance = null);
  },
  tick: function (time, timeDelta) {
    if (this.isDragging) return;
    const rotation = this.el.getAttribute('rotation');
    rotation.y += this.data.autoRotateSpeed;
    this.el.setAttribute('rotation', rotation);
  }
});

AFRAME.registerComponent('face-camera', {
  tick: function () {
    const camera = document.querySelector('[camera]');
    if (!camera) return;

    const object3D = this.el.object3D;
    const camPosition = new THREE.Vector3();
    camera.object3D.getWorldPosition(camPosition);
    object3D.lookAt(camPosition);
  }
});

      
  AFRAME.registerComponent('load-heart-labels', {
    init: function () {
      this.el.addEventListener('model-loaded', () => {
        const labels = [
          { name: "Aorta", position: { x: 1, y: 20, z: -5 }, color: "blue", audioId: "aortaAudio" },
          { name: "Right Ventricle", position: { x: 8, y: 9, z: 6 }, color: "blue", audioId: "aortaAudio" }
        ];

        labels.forEach(info => {
          const label = document.createElement('a-entity');
          label.setAttribute('position', info.position);
          label.setAttribute('geometry', 'primitive: plane; height: 1; width: 3');
          label.setAttribute('material', 'color: white; opacity: 0.9');
          label.setAttribute('text', `value: ${info.name}; align: center; width: 4; color: ${info.color}`);
          label.setAttribute('class', 'clickable');
          label.setAttribute('play-audio-on-click', `audioId: ${info.audioId}`);
          label.setAttribute('face-camera', '');
          this.el.appendChild(label);
        });
      });
    }
  });

  AFRAME.registerComponent('load-body-labels', {
    init: function () {
      this.el.addEventListener('model-loaded', () => {
        const labels = [
          { name: 'Liver', position: { x: 2, y: 2, z: -9 }, color: 'green', audioId: 'liverAudio' },
          { name: 'Stomach', position: { x: -3, y: 0, z: -9 }, color: 'green', audioId: 'liverAudio' },
          { name: 'Ribcage', position: { x: 2, y: 10, z: -9 }, color: 'green', audioId: 'liverAudio' }
        ];

        labels.forEach(info => {
          const label = document.createElement('a-entity');
          label.setAttribute('position', info.position);
          label.setAttribute('geometry', 'primitive: plane; height: 1; width: 3');
          label.setAttribute('material', 'color: white; opacity: 0.9');
          label.setAttribute('text', `value: ${info.name}; align: center; width: 4; color: ${info.color}`);
          label.setAttribute('class', 'clickable');
          label.setAttribute('play-audio-on-click', `audioId: ${info.audioId}`);
          label.setAttribute('face-camera', '');
          this.el.appendChild(label);
        });
      });
    }
  });

    </script>
  </body>
</html>
