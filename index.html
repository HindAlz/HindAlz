<!DOCTYPE html>
<html>
  <head>
    <title>Heart & Body WebAR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
    </style>
  </head>
  <body>
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; cameraParametersUrl: camera_para.dat">
      <a-assets>
        <a-asset-item id="heartGLB" src="heart.glb"></a-asset-item>
        <a-asset-item id="bodyGLB" src="body.glb"></a-asset-item>
        <audio id="aortaAudio" src="audio/aorta.mp3"></audio>
        <audio id="liverAudio" src="audio/aorta.mp3"></audio>
      </a-assets>

      <!-- Lighting -->
      <a-entity light="type: ambient; color: #ffffff; intensity: 10"></a-entity>

      <!-- Directional light to mimic sunlight -->
      <a-entity light="type: directional; color: #ffffff; intensity: 10" position="1 3 2"></a-entity>

      <!-- Heart Marker -->
      <a-marker id="heartMarker" type="pattern" url="heart-marker.patt" emitevents="true">
        <a-entity 
          id="heartModel" 
          gltf-model="#heartGLB" 
          scale="0.1 0.1 0.1" 
          rotation="-90 0 0"
          interactable-model
          load-heart-labels>
        </a-entity>
      </a-marker>

      <!-- Body Marker -->
      <a-marker id="bodyMarker" type="pattern" url="marker.patt" emitevents="true">
        <a-entity 
  id="bodyModel" 
  gltf-model="#bodyGLB" 
  scale="0.1 0.1 0.1"  
  rotation="0 0 0"
  interactable-model
  load-body-labels
  material="color: white;">
</a-entity>

      </a-marker>
      <a-entity light="type: ambient; intensity: 10; color: #ffffff"></a-entity>
      <a-entity light="type: directional; intensity: 10; position=1 2 1; color=#ffffff"></a-entity>
      
      <!-- Camera + Cursor -->
      <a-entity camera cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-scene>

    <script>
      // Add click-to-play audio behavior
      AFRAME.registerComponent('play-audio-on-click', {
        schema: { audioId: { type: 'string' } },
        init: function () {
          this.el.addEventListener('click', () => {
            const audio = document.getElementById(this.data.audioId);
            if (audio) {
              audio.play().catch(err => console.warn("Audio play failed:", err));
            }
          });
        }
      });

      // Zoom and rotate interaction
      AFRAME.registerComponent('interactable-model', {
        init: function () {
          const el = this.el;
          let isDragging = false;
          let previousX = null;

          // Rotate
          const onStart = (e) => {
            isDragging = true;
            previousX = e.touches ? e.touches[0].clientX : e.clientX;
          };
          const onMove = (e) => {
            if (!isDragging) return;
            const currentX = e.touches ? e.touches[0].clientX : e.clientX;
            const deltaX = currentX - previousX;
            previousX = currentX;

            const rotation = el.getAttribute('rotation');
            rotation.y += deltaX * 0.5;
            el.setAttribute('rotation', rotation);
          };
          const onEnd = () => { isDragging = false; };

          document.addEventListener('mousedown', onStart);
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onEnd);
          document.addEventListener('touchstart', onStart);
          document.addEventListener('touchmove', onMove);
          document.addEventListener('touchend', onEnd);

          // Zoom
          let initialDistance = null;
          window.addEventListener('wheel', (e) => {
            const scale = el.getAttribute('scale');
            const zoom = 1 + (e.deltaY > 0 ? -0.1 : 0.1);
            el.setAttribute('scale', {
              x: Math.max(0.01, scale.x * zoom),
              y: Math.max(0.01, scale.y * zoom),
              z: Math.max(0.01, scale.z * zoom)
            });
          });

          document.addEventListener('touchmove', function (e) {
            if (e.touches.length === 2) {
              const dx = e.touches[0].clientX - e.touches[1].clientX;
              const dy = e.touches[0].clientY - e.touches[1].clientY;
              const distance = Math.sqrt(dx * dx + dy * dy);

              if (initialDistance === null) {
                initialDistance = distance;
              } else {
                const scale = el.getAttribute('scale');
                const zoom = distance / initialDistance;
                el.setAttribute('scale', {
                  x: Math.max(0.01, scale.x * zoom),
                  y: Math.max(0.01, scale.y * zoom),
                  z: Math.max(0.01, scale.z * zoom)
                });
              }
            }
          });

          document.addEventListener('touchend', () => initialDistance = null);
        }
      });

      AFRAME.registerComponent('load-heart-labels', {
  init: function () {
    this.el.addEventListener('model-loaded', () => {
      const labels = [
        { name: "Aorta", position: { x: 1, y: 5, z: -10 }, color: "blue", audioId: "aortaAudio" },
        { name: "Right Ventricle", position: { x: 2, y: 6, z: 13 }, color: "blue", audioId: "aortaAudio" },
      ];

      labels.forEach((labelInfo) => {
        const label = document.createElement('a-entity');
        label.setAttribute('text', {
          value: labelInfo.name,
          color: labelInfo.color,
          align: 'center',
          width: 4
        });
        label.setAttribute('position', labelInfo.position);
        label.setAttribute('rotation', '0 180 0'); 

        label.setAttribute('geometry', {
          primitive: 'plane',
          height: 0.4,
          width: 2
        });
        label.setAttribute('material', {
          color: 'white',
          opacity: 0.85
        });
        label.setAttribute('class', 'clickable');
        label.setAttribute('play-audio-on-click', `audioId: ${labelInfo.audioId}`);
        label.setAttribute('look-at', '#mainCamera');
        this.el.appendChild(label);
      });
    });
  }
});


      // Body Labels (Multiple with look-at)
AFRAME.registerComponent('load-body-labels', {
  init: function () {
    this.el.addEventListener('model-loaded', () => {
      const labels = [
        { name: 'Liver', pos: { x: 2, y: 2, z: -9 }, color: 'green', audioId: 'liverAudio' },
        { name: 'Stomach', pos: { x: -3, y: 0, z: -9 }, color: 'green', audioId: 'liverAudio' },
        { name: 'Ribcage', pos: { x: 2, y: 10, z: -9 }, color: 'green', audioId: 'liverAudio' },
      ];

      labels.forEach(labelData => {
        const label = document.createElement('a-entity');
        label.setAttribute('text', {
          value: labelData.name,
          color: labelData.color,
          align: 'center',
          width: 4
        });
        label.setAttribute('position', labelData.pos);
        label.setAttribute('rotation', '0 180 0'); 
        label.setAttribute('geometry', {
          primitive: 'plane',
          height: 0.5,
          width: 2
        });
        label.setAttribute('material', {
          color: 'white',
          opacity: 0.8
        });
        label.setAttribute('class', 'clickable');
        label.setAttribute('play-audio-on-click', `audioId: ${labelData.audioId}`);
        label.setAttribute('look-at', '#mainCamera'); // Ensures the label faces the camera
        this.el.appendChild(label);
      });
    });
  }
});

    </script>
  </body>
</html>
